<script>
    // ========== EMAILJS INITIALIZATION ==========
    (function() {
        // Initialize EmailJS with your Public Key
        emailjs.init('q_bFfCJ9ViwpTh3gM'); // Your Public Key
    })();

    // ========== EMAILJS CONFIGURATION ==========
    const EMAILJS_CONFIG = {
        SERVICE_ID: 'service_4jl3pgs',          // Your Service ID
        ADMIN_TEMPLATE_ID: 'template_8asv08j',  // Admin Notification Template
        CUSTOMER_TEMPLATE_ID: 'template_xxxxxx', // Optional: Customer Confirmation Template
        ADMIN_EMAIL: 'arupborh1@gmail.com',     // Your email to receive orders
        FROM_EMAIL: 'Eastern Lumine <easternlumine@gmail.com>'
    };

    // ========== GLOBAL VARIABLES ==========
    let productPrice = 1; // Price per item
    let productName = 'Violet Necklace Set'; // Product name
    let quantity = 1; // Default quantity
    let isCOD = false;
    let codCharge = 0;
    let shippingCharge = 0;

    // ========== DOM ELEMENTS ==========
    let paymentMethods, onlinePayment, codPayment, checkoutBtn;
    let orderQuantity, productTotal, subtotal, shippingText, codChargeEl, grandTotal;
    let formInputs, errorMessages, successMessage;

    // ========== INITIALIZE PAGE ==========
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize DOM elements
        initializeDOMElements();
        
        // Get product data from localStorage or URL
        loadProductData();
        
        // Setup event listeners
        setupEventListeners();
        
        // Update initial display
        updateOrderSummary();
    });

    // ========== INITIALIZE DOM ELEMENTS ==========
    function initializeDOMElements() {
        // Payment elements
        paymentMethods = document.querySelectorAll('.payment-method');
        onlinePayment = document.getElementById('onlinePayment');
        codPayment = document.getElementById('codPayment');
        checkoutBtn = document.getElementById('checkoutBtn');
        
        // Order summary elements
        orderQuantity = document.getElementById('orderQuantity');
        productTotal = document.getElementById('productTotal');
        subtotal = document.getElementById('subtotal');
        shippingText = document.getElementById('shippingText');
        codChargeEl = document.getElementById('codCharge');
        grandTotal = document.getElementById('grandTotal');
        
        // Form elements
        formInputs = document.querySelectorAll('.form-input');
        errorMessages = document.querySelectorAll('.error-message');
        successMessage = document.getElementById('successMessage');
    }

    // ========== LOAD PRODUCT DATA ==========
    function loadProductData() {
        // First try to get from localStorage
        const productData = localStorage.getItem('productData');
        if (productData) {
            const data = JSON.parse(productData);
            productPrice = data.price || 1;
            productName = data.name || 'Product';
            quantity = data.quantity || 1;
        }
        
        // Then try URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('price')) {
            productPrice = parseInt(urlParams.get('price'));
        }
        if (urlParams.has('name')) {
            productName = decodeURIComponent(urlParams.get('name'));
        }
        if (urlParams.has('quantity')) {
            quantity = parseInt(urlParams.get('quantity'));
        }
        
        // Validate quantity
        if (quantity < 1) quantity = 1;
        if (quantity > 10) quantity = 10;
        
        // Update product name in order summary
        const productNameElement = document.querySelector('.order-item-name');
        if (productNameElement) {
            productNameElement.textContent = productName;
        }
        
        // Update unit price display
        const unitPriceElement = document.getElementById('unitPrice');
        if (unitPriceElement) {
            unitPriceElement.textContent = productPrice;
        }
    }

    // ========== SETUP EVENT LISTENERS ==========
    function setupEventListeners() {
        // Payment method selection
        if (paymentMethods.length > 0) {
            paymentMethods.forEach(method => {
                method.addEventListener('click', handlePaymentMethodChange);
            });
        }
        
        // Checkout button
        if (checkoutBtn) {
            checkoutBtn.addEventListener('click', handleCheckout);
        }
        
        // Form input saving
        formInputs.forEach(input => {
            input.addEventListener('input', saveFormData);
        });
        
        // Pincode auto-fill
        const pincodeInput = document.getElementById('pincode');
        if (pincodeInput) {
            pincodeInput.addEventListener('blur', autoFillCityState);
        }
    }

    // ========== PAYMENT METHOD HANDLER ==========
    function handlePaymentMethodChange() {
        // Remove selected class from all
        paymentMethods.forEach(m => m.classList.remove('selected'));
        
        // Add selected class to clicked
        this.classList.add('selected');
        
        // Update payment method
        const paymentType = this.querySelector('.payment-radio').value;
        isCOD = (paymentType === 'cod');
        
        // Update charges
        codCharge = isCOD ? 50 : 0;
        shippingCharge = isCOD ? 50 : 0;
        
        // Update button text
        if (checkoutBtn) {
            checkoutBtn.innerHTML = isCOD 
                ? '<i class="fas fa-truck"></i> Place COD Order'
                : '<i class="fas fa-lock"></i> Proceed to Payment';
        }
        
        // Update order summary
        updateOrderSummary();
    }

    // ========== UPDATE ORDER SUMMARY ==========
    function updateOrderSummary() {
        const productTotalAmount = productPrice * quantity;
        const total = productTotalAmount + shippingCharge;
        
        // Update display if elements exist
        if (orderQuantity) orderQuantity.textContent = quantity;
        if (productTotal) productTotal.textContent = productTotalAmount;
        if (subtotal) subtotal.textContent = productTotalAmount;
        if (codChargeEl) codChargeEl.textContent = codCharge;
        
        // Update shipping text
        if (shippingText) {
            if (isCOD) {
                shippingText.textContent = ' (COD Fee)';
                shippingText.style.color = 'var(--secondary)';
            } else {
                shippingText.textContent = ' (Free)';
                shippingText.style.color = '#2e8b57';
            }
        }
        
        if (grandTotal) grandTotal.textContent = total;
    }

    // ========== FORM VALIDATION ==========
    function validateForm() {
        let isValid = true;
        
        // Reset errors
        errorMessages.forEach(error => error.style.display = 'none');
        formInputs.forEach(input => input.classList.remove('error'));
        
        // Check Full Name
        const fullName = document.getElementById('fullName')?.value.trim();
        if (!fullName) {
            showError('nameError', 'fullName', 'Please enter your full name');
            isValid = false;
        }
        
        // Check Mobile Number
        const mobile = document.getElementById('mobileNumber')?.value.trim();
        const mobileRegex = /^[6-9]\d{9}$/;
        if (!mobileRegex.test(mobile)) {
            showError('mobileError', 'mobileNumber', 'Please enter a valid 10-digit mobile number');
            isValid = false;
        }
        
        // Check House Number
        const houseNo = document.getElementById('houseNo')?.value.trim();
        if (!houseNo) {
            showError('houseError', 'houseNo', 'Please enter house/flat number');
            isValid = false;
        }
        
        // Check Street/Area
        const streetArea = document.getElementById('streetArea')?.value.trim();
        if (!streetArea) {
            showError('streetError', 'streetArea', 'Please enter street/area details');
            isValid = false;
        }
        
        // Check City
        const city = document.getElementById('city')?.value.trim();
        if (!city) {
            showError('cityError', 'city', 'Please enter city');
            isValid = false;
        }
        
        // Check State
        const state = document.getElementById('state')?.value.trim();
        if (!state) {
            showError('stateError', 'state', 'Please enter state');
            isValid = false;
        }
        
        // Check Pincode
        const pincode = document.getElementById('pincode')?.value.trim();
        const pincodeRegex = /^\d{6}$/;
        if (!pincodeRegex.test(pincode)) {
            showError('pincodeError', 'pincode', 'Please enter a valid 6-digit pincode');
            isValid = false;
        }
        
        return isValid;
    }
    
    function showError(errorId, inputId, message) {
        const errorElement = document.getElementById(errorId);
        const inputElement = document.getElementById(inputId);
        
        if (errorElement && inputElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            inputElement.classList.add('error');
        }
    }

    // ========== CHECKOUT HANDLER ==========
    function handleCheckout() {
        // Validate form
        if (!validateForm()) {
            alert('Please fill all required fields correctly.');
            return;
        }
        
        if (isCOD) {
            // Cash on Delivery
            placeCODOrder();
        } else {
            // Online Payment
            processOnlinePayment();
        }
    }

    // ========== CASH ON DELIVERY ORDER ==========
    function placeCODOrder() {
        // Collect form data
        const orderData = collectOrderData('cod');
        
        // Send email to admin
        sendOrderEmailToAdmin(orderData);
        
        // Save order locally
        localStorage.setItem('lastOrder', JSON.stringify(orderData));
        
        // Show success
        showOrderSuccess(orderData, 'cod');
    }

    // ========== ONLINE PAYMENT PROCESSING ==========
    function processOnlinePayment() {
        const amount = parseInt(grandTotal.textContent) * 100; // Convert to paise
        
        // Collect order data
        const orderData = collectOrderData('online');
        
        // YOUR RAZORPAY KEY - REPLACE WITH YOUR LIVE KEY
        const razorpayKeyId = 'rzp_live_RpASpuQWPHN0ae';
        
        const options = {
            key: razorpayKeyId,
            amount: amount,
            currency: 'INR',
            name: 'Eastern Lumine',
            description: productName,
            image: 'https://your-logo-url.com/logo.png',
            
            handler: function(response) {
                handlePaymentSuccess(response, orderData);
            },
            
            prefill: {
                name: orderData.customerName,
                contact: orderData.mobile,
                email: orderData.email || 'customer@example.com'
            },
            
            notes: {
                address: orderData.streetArea + ', ' + orderData.city,
                product: productName
            },
            
            theme: {
                color: '#b8860b'
            }
        };
        
        const rzp = new Razorpay(options);
        rzp.open();
        
        rzp.on('payment.failed', function(response) {
            alert('Payment failed. Please try again. Error: ' + response.error.description);
        });
    }

    // ========== COLLECT ORDER DATA ==========
    function collectOrderData(paymentMethod) {
        return {
            orderId: 'EL-' + Date.now(),
            customerName: document.getElementById('fullName').value.trim(),
            mobile: document.getElementById('mobileNumber').value.trim(),
            email: document.getElementById('customerEmail')?.value.trim() || '',
            houseNo: document.getElementById('houseNo').value.trim(),
            streetArea: document.getElementById('streetArea').value.trim(),
            landmark: document.getElementById('landmark').value.trim(),
            city: document.getElementById('city').value.trim(),
            state: document.getElementById('state').value.trim(),
            pincode: document.getElementById('pincode').value.trim(),
            paymentMethod: paymentMethod,
            product: productName,
            quantity: quantity,
            unitPrice: productPrice,
            totalAmount: parseInt(grandTotal.textContent),
            orderDate: new Date().toISOString()
        };
    }

    // ========== SEND EMAIL TO ADMIN ==========
    function sendOrderEmailToAdmin(orderData) {
        // Prepare email parameters
        const emailParams = {
            admin_email: EMAILJS_CONFIG.ADMIN_EMAIL,
            order_id: orderData.orderId,
            order_date: new Date().toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            }),
            customer_name: orderData.customerName,
            customer_mobile: orderData.mobile,
            customer_email: orderData.email || 'Not provided',
            
            shipping_address: `
                ${orderData.houseNo}, 
                ${orderData.streetArea}
                ${orderData.landmark ? ` (Landmark: ${orderData.landmark})` : ''}
                ${orderData.city}, ${orderData.state}
                Pincode: ${orderData.pincode}
                India
            `,
            
            product_name: orderData.product,
            quantity: orderData.quantity,
            unit_price: orderData.unitPrice,
            product_total: orderData.unitPrice * orderData.quantity,
            cod_charge: orderData.paymentMethod === 'cod' ? '50' : '',
            grand_total: orderData.totalAmount,
            payment_method: orderData.paymentMethod === 'cod' ? 'Cash on Delivery (COD)' : 'Online Payment',
            payment_status: orderData.paymentMethod === 'cod' ? 'pending' : 'paid'
        };
        
        console.log('üìß Sending email with data:', emailParams);
        
        // Send email using EmailJS
        emailjs.send(
            EMAILJS_CONFIG.SERVICE_ID,
            EMAILJS_CONFIG.ADMIN_TEMPLATE_ID,
            emailParams
        )
        .then(function(response) {
            console.log('‚úÖ Email sent successfully!', response.status, response.text);
            
            // Optional: Send customer confirmation
            if (orderData.email) {
                sendCustomerConfirmation(orderData);
            }
        })
        .catch(function(error) {
            console.error('‚ùå Email sending failed:', error);
            // Don't show error to customer, just log it
        });
    }

    // ========== HANDLE PAYMENT SUCCESS ==========
    function handlePaymentSuccess(response, orderData) {
        const completeOrder = {
            ...orderData,
            paymentId: response.razorpay_payment_id,
            paymentStatus: 'paid'
        };
        
        // Send email to admin
        sendOrderEmailToAdmin(completeOrder);
        
        // Save order locally
        localStorage.setItem('lastOrder', JSON.stringify(completeOrder));
        
        // Show success
        showOrderSuccess(completeOrder, 'online', response.razorpay_payment_id);
    }

    // ========== SHOW ORDER SUCCESS ==========
    function showOrderSuccess(orderData, paymentMethod, paymentId = '') {
        // Update success message
        if (successMessage) {
            successMessage.style.display = 'block';
            successMessage.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 50px; color: #28a745; margin-bottom: 15px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 style="color: #155724; margin-bottom: 15px;">
                        ${paymentMethod === 'cod' ? 'COD Order Placed!' : 'Payment Successful!'}
                    </h3>
                    
                    <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: left;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-receipt" style="color: #b8860b; margin-right: 10px;"></i>
                            <strong>Order ID:</strong> ${orderData.orderId}
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-rupee-sign" style="color: #b8860b; margin-right: 10px;"></i>
                            <strong>Total Amount:</strong> ‚Çπ${orderData.totalAmount}
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-credit-card" style="color: #b8860b; margin-right: 10px;"></i>
                            <strong>Payment Method:</strong> 
                            ${paymentMethod === 'cod' ? 'Cash on Delivery' : 'Online Payment'}
                        </div>
                        ${paymentId ? `
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-id-card" style="color: #b8860b; margin-right: 10px;"></i>
                            <strong>Payment ID:</strong> ${paymentId}
                        </div>
                        ` : ''}
                    </div>
                    
                    <p style="color: #666; font-size: 14px; margin-top: 15px;">
                        <i class="fas fa-envelope"></i> Order notification sent to admin.
                    </p>
                    
                    ${paymentMethod === 'cod' ? `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ffc107;">
                        <i class="fas fa-info-circle" style="color: #856404; margin-right: 8px;"></i>
                        <strong>Note:</strong> Collect ‚Çπ${orderData.totalAmount} when order is delivered.
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Disable checkout button
        if (checkoutBtn) {
            checkoutBtn.disabled = true;
            checkoutBtn.innerHTML = paymentMethod === 'cod' 
                ? '<i class="fas fa-check"></i> COD Order Placed'
                : '<i class="fas fa-check"></i> Payment Successful';
            checkoutBtn.style.background = '#28a745';
        }
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Show alert
        setTimeout(() => {
            if (paymentMethod === 'cod') {
                alert(`‚úÖ COD Order Placed Successfully!\n\nüì¶ Order ID: ${orderData.orderId}\nüí∞ Amount to Collect: ‚Çπ${orderData.totalAmount}\nüë§ Customer: ${orderData.customerName}\nüì± Mobile: ${orderData.mobile}\n\nüìß Order notification sent to admin email.\n\nThank you for your order!`);
            } else {
                alert(`‚úÖ Payment Successful!\n\nüì¶ Order ID: ${orderData.orderId}\nüí∞ Amount Paid: ‚Çπ${orderData.totalAmount}\nüí≥ Payment ID: ${paymentId}\nüë§ Customer: ${orderData.customerName}\nüì± Mobile: ${orderData.mobile}\n\nüìß Order notification sent to admin.\n\nThank you for shopping with us!`);
            }
        }, 500);
        
        // Clear form data after 5 seconds
        setTimeout(() => {
            localStorage.removeItem('checkoutFormData');
            localStorage.removeItem('productData');
        }, 5000);
    }

    // ========== SEND CUSTOMER CONFIRMATION (OPTIONAL) ==========
    function sendCustomerConfirmation(orderData) {
        // Only send if customer provided email
        if (!orderData.email) return;
        
        const customerParams = {
            to_email: orderData.email,
            customer_name: orderData.customerName,
            order_id: orderData.orderId,
            order_date: new Date().toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }),
            product_name: orderData.product,
            quantity: orderData.quantity,
            total_amount: orderData.totalAmount,
            payment_method: orderData.paymentMethod === 'cod' ? 'Cash on Delivery' : 'Online Payment',
            estimated_delivery: '6-7 business days',
            support_email: 'easternlumine@gmail.com',
            support_phone: '+91 6002148763'
        };
        
        emailjs.send(
            EMAILJS_CONFIG.SERVICE_ID,
            EMAILJS_CONFIG.CUSTOMER_TEMPLATE_ID,
            customerParams
        )
        .then(function(response) {
            console.log('Customer confirmation sent!', response.status, response.text);
        })
        .catch(function(error) {
            console.error('Customer email failed:', error);
        });
    }

    // ========== SAVE FORM DATA ==========
    function saveFormData() {
        const formData = {
            fullName: document.getElementById('fullName')?.value || '',
            mobile: document.getElementById('mobileNumber')?.value || '',
            houseNo: document.getElementById('houseNo')?.value || '',
            streetArea: document.getElementById('streetArea')?.value || '',
            landmark: document.getElementById('landmark')?.value || '',
            city: document.getElementById('city')?.value || '',
            state: document.getElementById('state')?.value || '',
            pincode: document.getElementById('pincode')?.value || ''
        };
        
        localStorage.setItem('checkoutFormData', JSON.stringify(formData));
    }

    // ========== LOAD SAVED FORM DATA ==========
    function loadSavedFormData() {
        const savedData = localStorage.getItem('checkoutFormData');
        if (savedData) {
            const formData = JSON.parse(savedData);
            
            Object.keys(formData).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = formData[key];
                }
            });
        }
    }

    // ========== AUTO-FILL CITY/STATE FROM PINCODE ==========
    function autoFillCityState() {
        const pincode = this.value.trim();
        if (/^\d{6}$/.test(pincode)) {
            // You can use India Post API here if needed
            // For now, we'll leave it empty
            console.log('Valid pincode:', pincode);
            // fetch(`https://api.postalpincode.in/pincode/${pincode}`)
            //   .then(response => response.json())
            //   .then(data => {
            //       if (data[0].Status === 'Success') {
            //           document.getElementById('city').value = data[0].PostOffice[0].District;
            //           document.getElementById('state').value = data[0].PostOffice[0].State;
            //       }
            //   });
        }
    }

    // ========== LOAD SAVED DATA ON PAGE LOAD ==========
    window.addEventListener('load', function() {
        loadSavedFormData();
    });

    // ========== TEST EMAIL FUNCTION (FOR DEBUGGING) ==========
    function testEmail() {
        const testData = {
            admin_email: 'arupborh1@gmail.com',
            order_id: 'EL-TEST-' + Date.now(),
            order_date: new Date().toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            }),
            customer_name: 'Test Customer',
            customer_mobile: '9876543210',
            customer_email: 'test@example.com',
            shipping_address: '123 Test Street, Test Area, Test City, Test State - 123456',
            product_name: 'Test Product',
            quantity: 2,
            unit_price: 1,
            product_total: 2,
            cod_charge: '50',
            grand_total: 52,
            payment_method: 'Cash on Delivery (COD)',
            payment_status: 'pending'
        };
        
        console.log('Sending test email...', testData);
        
        emailjs.send(
            EMAILJS_CONFIG.SERVICE_ID,
            EMAILJS_CONFIG.ADMIN_TEMPLATE_ID,
            testData
        )
        .then(function(response) {
            console.log('‚úÖ Test email sent successfully!', response);
            alert('Test email sent to ' + EMAILJS_CONFIG.ADMIN_EMAIL);
        })
        .catch(function(error) {
            console.error('‚ùå Test email failed:', error);
            alert('Test email failed: ' + error.text);
        });
    }
</script>